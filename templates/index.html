{% extends 'base.html' %}

{% block title %}Explore Recipes - RecipeHub{% endblock %}

{% block content %}
<div style="margin-bottom: 4rem;">
    {% if query %}
    <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
        <div>
            <h2 style="font-size: 2rem; font-weight: 800; color: var(--text-main); letter-spacing: -0.02em;">Results for
                "{{
                query }}"</h2>
            <p style="color: var(--text-muted); font-size: 1.1rem;">Discovering unique flavors for you...</p>
        </div>

    </div>
    {% else %}
    <div
        style="padding: 5rem 2rem; text-align: center; background: linear-gradient(135deg, #fffcf9 0%, #fff7ed 100%); border-radius: 32px; border: 1px solid rgba(249, 115, 22, 0.05); box-shadow: 0 20px 50px rgba(0,0,0,0.02); position: relative; overflow: hidden;">
        <div
            style="position: absolute; top: -10%; right: -5%; width: 300px; height: 300px; background: radial-gradient(circle, rgba(249, 115, 22, 0.05) 0%, transparent 70%); border-radius: 50%;">
        </div>
        <h1
            style="font-size: 3.5rem; font-weight: 900; color: #1c1917; margin-bottom: 1.5rem; letter-spacing: -0.04em; line-height: 1.1;">
            Savor Every <span style="color: var(--primary);">Moment.</span></h1>
        <p style="font-size: 1.25rem; color: #44403c; max-width: 650px; margin: 0 auto; line-height: 1.7;">
            Master new flavors and share your culinary journey with a community that loves food as much as you do.
        </p>
    </div>
    {% endif %}
</div>

<!-- Category Navigation -->
<div class="category-tabs" style="margin-top: -1rem; margin-bottom: 3rem;">
    <a href="{{ url_for('index', category='All') }}" class="tab-btn {% if active_category == 'All' %}active{% endif %}">
        <i class="fas fa-utensils"></i> All Recipes
    </a>
    <a href="{{ url_for('index', category='Breakfast') }}"
        class="tab-btn {% if active_category == 'Breakfast' %}active{% endif %}">
        <i class="fas fa-egg"></i> Breakfast
    </a>
    <a href="{{ url_for('index', category='Lunch') }}"
        class="tab-btn {% if active_category == 'Lunch' %}active{% endif %}">
        <i class="fas fa-hamburger"></i> Lunch
    </a>
    <a href="{{ url_for('index', category='Dinner') }}"
        class="tab-btn {% if active_category == 'Dinner' %}active{% endif %}">
        <i class="fas fa-pizza-slice"></i> Dinner
    </a>
    <a href="{{ url_for('index', category='Instant') }}"
        class="tab-btn {% if active_category == 'Instant' %}active{% endif %}">
        <i class="fas fa-bolt"></i> Instant
    </a>
    <a href="{{ url_for('index', category='Bakery') }}"
        class="tab-btn {% if active_category == 'Bakery' %}active{% endif %}">
        <i class="fas fa-bread-slice"></i> Bakery
    </a>
    <a href="{{ url_for('index', category='Snacks') }}"
        class="tab-btn {% if active_category == 'Snacks' %}active{% endif %}">
        <i class="fas fa-cookie"></i> Snacks
    </a>
    <a href="{{ url_for('index', category='Healthy') }}"
        class="tab-btn {% if active_category == 'Healthy' %}active{% endif %}">
        <i class="fas fa-leaf"></i> Healthy
    </a>
</div>

<div class="recipe-grid">
    {% for recipe in recipes %}
    <div class="card">
        <div class="video-container skeleton" style="border-radius: 20px 20px 0 0;">
            {% if recipe.thumbnail %}
            <div class="thumbnail-cover" data-recipe-id="{{ recipe.id }}"
                onclick="const vid = this.nextElementSibling; this.style.display='none'; vid.style.display='block'; vid.play(); vid.controls = true; fetch(`/view/{{ recipe.id }}`, { method: 'POST' });">
                <img src="{{ recipe.thumbnail if recipe.thumbnail.startswith('http') else url_for('static', filename='uploads/thumbnails/' + recipe.thumbnail) }}"
                    alt="{{ recipe.title }}"
                    onerror="this.src='https://images.unsplash.com/photo-1495195129352-aec325b55b75?q=80&w=2070&auto=format&fit=crop'; this.closest('.thumbnail-cover').style.background='#f3f4f6';">
                <div class="play-trigger">
                    <i class="fas fa-play"></i>
                </div>
            </div>
            <video preload="none" style="width: 100%; height: 100%; border: none; display: none;"
                data-recipe-id="{{ recipe.id }}" onclick="togglePlay(this, '{{ recipe.id }}')">
                <source
                    src="{{ recipe.video_filename if recipe.video_filename.startswith('http') else url_for('static', filename='uploads/videos/' + recipe.video_filename) }}"
                    type="video/mp4">
            </video>
            {% else %}
            <video preload="metadata" style="width: 100%; height: 100%; border: none; cursor: pointer;"
                data-recipe-id="{{ recipe.id }}" onclick="togglePlay(this, this.getAttribute('data-recipe-id'))">
                <source
                    src="{{ recipe.video_filename if recipe.video_filename.startswith('http') else url_for('static', filename='uploads/videos/' + recipe.video_filename) }}"
                    type="video/mp4">
            </video>
            <div class="play-trigger" style="pointer-events: none;">
                <i class="fas fa-play"></i>
            </div>
            {% endif %}

            <div class="video-overlay"
                style="position: absolute; top: 1rem; right: 1rem; pointer-events: none; z-index: 3;">
                <span class="view-badge"
                    style="background: rgba(15, 23, 42, 0.7); color: white; padding: 0.4rem 0.8rem; border-radius: 12px; font-size: 0.725rem; font-weight: 800; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.1);">
                    <i class="fas fa-eye" style="margin-right: 4px;"></i> {{ recipe.views }}
                </span>
            </div>

            <!-- Mobile Info Toggle Button -->
            <button class="info-toggle-btn" onclick="toggleCardInfo(this)" title="Show Details">
                <i class="fas fa-video"></i>
            </button>
        </div>
        <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                <h3 class="card-title">{{ recipe.title }}</h3>
                <span class="badge">{{ recipe.category or 'Recipe' }}</span>
            </div>

            {% if recipe.description %}
            <div class="recipe-card-description" style="cursor: pointer;"
                onclick="viewFullRecipe(this.closest('.card'))">
                {{ recipe.description }}
            </div>
            {% endif %}

            <div class="card-quote">
                {{ (recipe.instructions or "Crafted with passion and precision by our community chef.")|truncate(80) }}
            </div>

            <!-- Hidden Data for Modal -->
            <div class="recipe-data" style="display: none;" data-id="{{ recipe.id }}" data-title="{{ recipe.title }}"
                data-description="{{ recipe.description or '' }}" data-ingredients="{{ recipe.ingredients or '' }}"
                data-instructions="{{ recipe.instructions or '' }}">
            </div>

            <div style="display: flex; gap: 0.75rem; margin-top: auto;">
                <button class="btn btn-primary" style="flex: 1; padding: 1rem; font-weight: 800; letter-spacing: 0.5px;"
                    onclick="viewFullRecipe(this.closest('.card'))">
                    <i class="fas fa-utensils"></i> Open Recipe
                </button>
                <button class="btn btn-outline like-btn {% if recipe.user_liked %}active{% endif %}"
                    style="width: 50px; height: 50px; background: #f8fafc; border: 1px solid #f1f5f9; border-radius: 16px;"
                    data-recipe-id="{{ recipe.id }}" onclick="toggleLike(this.getAttribute('data-recipe-id'), this)">
                    <i class="{% if recipe.user_liked %}fas liked{% else %}far{% endif %} fa-heart"></i>
                </button>
                <button class="btn btn-outline"
                    style="width: 50px; height: 50px; background: #f8fafc; border: 1px solid #f1f5f9; color: #64748b; border-radius: 16px;"
                    data-title="{{ recipe.title }}" data-recipe-id="{{ recipe.id }}"
                    onclick="shareRecipe(this.getAttribute('data-title'), this.getAttribute('data-recipe-id'))">
                    <i class="fas fa-share-alt"></i>
                </button>
            </div>

            <div
                style="margin-top: 1.25rem; font-size: 0.75rem; color: #94a3b8; font-weight: 700; display: flex; gap: 1.25rem; border-top: 1px solid #f1f5f9; padding-top: 1.25rem;">
                <span><i class="fas fa-heart" style="color: #ef4444; margin-right: 4px;"></i> <span
                        class="like-counter">{{ recipe.like_count or 0 }}</span> Likes</span>
                <span><i class="fas fa-clock" style="margin-right: 4px;"></i> {{ recipe.cooking_time or 0 }} mins</span>
                <span><i class="fas fa-globe" style="margin-right: 4px;"></i> Global</span>
            </div>

            <div class="author-plate" style="margin-top: 1.5rem;">
                <div
                    style="width: 42px; height: 42px; background: linear-gradient(135deg, var(--text-main), #334155); border-radius: 14px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1rem; font-weight: 950; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    {{ recipe.username[0]|upper }}
                </div>
                <div style="flex: 1;">
                    <div style="font-weight: 800; font-size: 0.9rem; color: var(--text-main); line-height: 1.2;">{{
                        recipe.username }}</div>
                    <div style="font-size: 0.725rem; color: var(--text-muted); font-weight: 600;">Culinary Architect
                    </div>
                </div>
                <div style="text-align: right;">
                    <div
                        style="font-size: 0.775rem; color: var(--text-muted); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px;">
                        {{ recipe.created_at.strftime('%b %d') if recipe.created_at else 'Today' }}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

{% if youtube_recipes %}
<div style="margin-top: 5rem;">
    <h2
        style="font-size: 1.5rem; font-weight: 800; margin-bottom: 2rem; display: flex; align-items: center; gap: 0.75rem;">
        <i class="fab fa-youtube" style="color: #ff0000; font-size: 1.8rem;"></i>
        YouTube Culinary References
    </h2>
    <div class="recipe-grid">
        {% for video in youtube_recipes %}
        <div class="card" onclick="playYouTube('{{ video.id }}')"
            style="cursor: pointer; border: 1px solid rgba(255, 0, 0, 0.05);">
            <div class="thumbnail-container"
                style="border-radius: 20px 20px 0 0; overflow: hidden; position: relative;">
                <img src="{{ video.thumbnails[0].url if video.thumbnails else '' }}" alt="{{ video.title }}"
                    style="width: 100%; height: 200px; object-fit: cover;">
                <div
                    style="position: absolute; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.2);">
                    <i class="fas fa-play-circle" style="color: white; font-size: 3rem; opacity: 0.8;"></i>
                </div>
            </div>
            <div class="card-body" style="padding: 1.5rem;">
                <h3 class="card-title" style="font-size: 1.1rem; height: 2.8em; overflow: hidden;">{{ video.title }}
                </h3>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1rem;">
                    <span class="badge" style="background: rgba(255, 0, 0, 0.1); color: #ff0000;">YouTube</span>
                    <button class="btn btn-outline" style="padding: 0.4rem; font-size: 0.8rem;"
                        onclick="event.stopPropagation(); shareYT('{{ video.id }}')">
                        <i class="fas fa-share-alt"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Recipe Modal -->
<div id="recipeModal" class="modal" onclick="closeRecipeModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modalTitle"></h2>
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="downloadRecipePDF()" class="close-simple pdf-download-btn" title="Download PDF">
                    <i class="fas fa-file-pdf fa-lg"></i>
                </button>
                <button class="close-simple" onclick="closeRecipeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        <div id="modalDescription" style="color: #64748b; font-size: 0.95rem; margin-bottom: 1.5rem; line-height: 1.6;">
        </div>
        <div class="simple-section-title"><i class="fas fa-leaf"></i> Ingredients</div>
        <div id="modalIngredients" class="compact-ingredients"></div>
        <div class="simple-section-title"><i class="fas fa-list-ol"></i> Instructions</div>
        <div id="modalInstructions" class="compact-steps"></div>

        <div class="comments-section" style="margin-top: 2.5rem; border-top: 1px solid #f1f5f9; padding-top: 2rem;">
            <div class="simple-section-title"><i class="fas fa-comments"></i> Community Comments</div>

            <div id="commentsList" style="margin-bottom: 2rem; display: flex; flex-direction: column; gap: 1rem;">
                <!-- Comments will be loaded here -->
                <div style="text-align: center; color: #94a3b8; font-size: 0.9rem; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin"
                        style="font-size: 1.5rem; margin-bottom: 1rem; display: block;"></i>
                    Loading comments...
                </div>
            </div>

            {% if session.get('user_id') %}
            <div class="comment-form-container">
                <form id="commentForm" onsubmit="submitComment(event)" style="display: flex; gap: 0.75rem;">
                    <div
                        style="width: 40px; height: 40px; border-radius: 12px; overflow: hidden; flex-shrink: 0; border: 2px solid var(--primary-light);">
                        {% if session.get('profile_photo') %}
                        <img src="{{ session['profile_photo'] }}" style="width: 100%; height: 100%; object-fit: cover;">
                        {% else %}
                        <div
                            style="width: 100%; height: 100%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 800;">
                            {{ session['username'][0]|upper }}
                        </div>
                        {% endif %}
                    </div>
                    <div style="flex: 1; position: relative;">
                        <textarea id="commentInput" placeholder="Add a public comment..."
                            style="width: 100%; border: 1px solid #e2e8f0; border-radius: 12px; padding: 0.75rem; padding-right: 3rem; font-family: inherit; font-size: 0.9rem; resize: none; min-height: 44px; outline: none; transition: border-color 0.2s;"
                            onfocus="this.style.borderColor = 'var(--primary)'"
                            onblur="this.style.borderColor = '#e2e8f0'"></textarea>
                        <button type="submit"
                            style="position: absolute; right: 8px; bottom: 8px; background: var(--primary); color: white; border: none; width: 28px; height: 28px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;"
                            onmouseover="this.style.transform = 'scale(1.1)'"
                            onmouseout="this.style.transform = 'scale(1)'">
                            <i class="fas fa-paper-plane" style="font-size: 0.8rem;"></i>
                        </button>
                    </div>
                </form>
            </div>
            {% else %}
            <div
                style="background: #f8fafc; padding: 1.25rem; border-radius: 16px; text-align: center; border: 1px dashed #e2e8f0;">
                <p style="font-size: 0.85rem; color: #64748b; margin-bottom: 0.75rem;">Join the conversation to share
                    your thoughts!</p>
                <a href="{{ url_for('login') }}" class="btn btn-primary"
                    style="padding: 0.5rem 1.25rem; font-size: 0.8rem;">Sign In to Comment</a>
            </div>
            {% endif %}
        </div>
        <input type="hidden" id="currentRecipeId">
    </div>
</div>

<!-- YouTube Video Modal -->
<div id="videoModal" class="modal" onclick="closeYTModal()">
    <div class="modal-content" onclick="event.stopPropagation()"
        style="max-width: 800px; padding: 0; background: #000; overflow: hidden;">
        <div style="position: relative; padding-bottom: 56.25%; height: 0;">
            <iframe id="youtubePlayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;"
                frameborder="0" allow="autoplay; fullscreen"></iframe>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
    function togglePlay(vid, id) {
        if (vid.paused) { vid.play(); vid.controls = true; fetch(`/view/${id}`, { method: 'POST' }); }
        else { vid.pause(); }
    }

    function toggleCardInfo(btn) {
        const card = btn.closest('.card');
        card.classList.toggle('show-info');
        const icon = btn.querySelector('i');
        if (card.classList.contains('show-info')) {
            icon.className = 'fas fa-chevron-up';
            btn.style.background = 'var(--primary)';
            btn.style.color = 'white';
        } else {
            icon.className = 'fas fa-video';
            btn.style.background = 'rgba(255, 255, 255, 0.9)';
            btn.style.color = 'var(--primary)';
        }
    }

    async function toggleLike(id, btn) {
        const icon = btn.querySelector('i');
        const counter = btn.closest('.card-body').querySelector('.like-counter');
        const isLiked = icon.classList.contains('fas');
        let currentCount = parseInt(counter.textContent);

        // Optimistic UI update
        icon.className = isLiked ? 'far fa-heart' : 'fas fa-heart';
        btn.style.color = isLiked ? '#64748b' : '#ef4444';
        counter.textContent = isLiked ? Math.max(0, currentCount - 1) : currentCount + 1;

        try {
            const res = await fetch(`/like/${id}`, { method: 'POST' });
            if (res.status === 401) {
                window.location.href = "{{ url_for('login') }}";
                return;
            }
            const data = await res.json();

            // Sync with server response
            icon.className = data.liked ? 'fas fa-heart' : 'far fa-heart';
            btn.style.color = data.liked ? '#ef4444' : '#64748b';
            counter.textContent = data.count;
        } catch (err) {
            // Revert on error
            icon.className = isLiked ? 'fas fa-heart' : 'far fa-heart';
            btn.style.color = isLiked ? '#ef4444' : '#64748b';
            counter.textContent = currentCount;
            console.error('Like error:', err);
        }
    }

    async function viewFullRecipe(card) {
        const d = card.querySelector('.recipe-data').dataset;
        document.getElementById('modalTitle').textContent = d.title;
        document.getElementById('modalDescription').textContent = d.description;
        document.getElementById('currentRecipeId').value = d.id;
        const ing = document.getElementById('modalIngredients');
        ing.innerHTML = (d.ingredients || '').split('\n').filter(x => x.trim()).map(x => `<span class="ing-tag">${x}</span>`).join('');
        const ins = document.getElementById('modalInstructions');
        ins.innerHTML = (d.instructions || d.description || '').split('\n').filter(x => x.trim()).map((x, i) => `<div class="simple-step"><strong>Step ${i + 1}:</strong> ${x}</div>`).join('');

        // Load comments
        loadComments(d.id);

        document.getElementById('recipeModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    async function loadComments(recipeId) {
        const list = document.getElementById('commentsList');
        try {
            const res = await fetch(`/comments/${recipeId}`);
            const data = await res.json();

            if (data.comments.length === 0) {
                list.innerHTML = `
                    <div style="text-align: center; color: #94a3b8; padding: 2rem; background: #f8fafc; border-radius: 16px;">
                        <i class="far fa-comment-dots" style="font-size: 2rem; margin-bottom: 0.5rem; display: block;"></i>
                        <p style="font-size: 0.85rem;">Be the first to share your thoughts!</p>
                    </div>
                `;
            } else {
                list.innerHTML = data.comments.map(c => `
                    <div class="comment-item" style="display: flex; gap: 0.75rem; animation: fadeIn 0.4s ease-out forwards;">
                        <div style="width: 36px; height: 36px; border-radius: 10px; overflow: hidden; flex-shrink: 0; background: var(--primary-light);">
                            ${c.profile_photo ?
                        `<img src="${c.profile_photo}" style="width: 100%; height: 100%; object-fit: cover;">` :
                        `<div style="width: 100%; height: 100%; background: var(--primary); color: white; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 0.8rem;">${c.username[0].toUpperCase()}</div>`
                    }
                        </div>
                        <div style="flex: 1; background: #f8fafc; padding: 0.75rem 1rem; border-radius: 0 16px 16px 16px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                <span style="font-weight: 700; font-size: 0.85rem; color: var(--text-main);">${c.username}</span>
                                <span style="font-size: 0.7rem; color: var(--text-muted);">${c.created_at}</span>
                            </div>
                            <p style="font-size: 0.9rem; color: #475569; line-height: 1.5; margin: 0;">${c.comment}</p>
                        </div>
                    </div>
                `).join('');
            }
        } catch (err) {
            list.innerHTML = `<div style="color: #ef4444; font-size: 0.85rem; text-align: center;">Failed to load comments</div>`;
        }
    }

    async function submitComment(event) {
        event.preventDefault();
        const input = document.getElementById('commentInput');
        const comment = input.value.trim();
        const recipeId = document.getElementById('currentRecipeId').value;

        if (!comment) return;

        const btn = event.target.querySelector('button');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

        try {
            const formData = new FormData();
            formData.append('recipe_id', recipeId);
            formData.append('comment', comment);

            const res = await fetch('/comment/post', {
                method: 'POST',
                body: formData
            });

            if (res.ok) {
                input.value = '';
                loadComments(recipeId);
            } else {
                alert('Failed to post comment. Please try again.');
            }
        } catch (err) {
            console.error('Comment Error:', err);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-paper-plane" style="font-size: 0.8rem;"></i>';
        }
    }

    function closeRecipeModal() {
        document.getElementById('recipeModal').style.display = 'none';
        document.body.style.overflow = 'auto';
    }

    function playYouTube(id) {
        document.getElementById('youtubePlayer').src = `https://www.youtube.com/embed/${id}?autoplay=1`;
        document.getElementById('videoModal').style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }

    function closeYTModal() {
        document.getElementById('videoModal').style.display = 'none';
        document.getElementById('youtubePlayer').src = '';
        document.body.style.overflow = 'auto';
    }

    function shareRecipe(title, id) {
        const url = window.location.origin + '/?id=' + id;
        navigator.clipboard.writeText(url);
        alert('Recipe link copied!');
    }

    function shareYT(id) {
        const url = 'https://www.youtube.com/watch?v=' + id;
        navigator.clipboard.writeText(url);
        alert('YouTube link copied!');
    }

    function downloadRecipePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const title = document.getElementById('modalTitle').textContent;
        const description = document.getElementById('modalDescription').textContent;
        const ingredients = Array.from(document.getElementById('modalIngredients').querySelectorAll('.ing-tag')).map(el => el.textContent);
        const instructions = Array.from(document.getElementById('modalInstructions').querySelectorAll('.simple-step')).map(el => el.textContent.replace(/^Step \d+:\s*/, ''));

        const primary = [249, 115, 22]; // RecipeHub Orange
        const dark = [17, 24, 39];      // Deep Slate
        const light = [241, 245, 249];  // Light Gray

        // --- 1. Sidebar Design ---
        doc.setFillColor(...dark);
        doc.rect(0, 0, 75, 297, 'F');

        // Logo
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(26);
        doc.setFont(undefined, 'bold');
        doc.text("RECIPE", 37.5, 30, { align: "center" });
        doc.setTextColor(...primary);
        doc.text("HUB", 37.5, 40, { align: "center" });

        doc.setDrawColor(51, 65, 85);
        doc.setLineWidth(0.5);
        doc.line(15, 50, 60, 50);

        // Sidebar Content: Ingredients
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(14);
        doc.setFont(undefined, 'bold');
        doc.text("INGREDIENTS", 15, 65);

        doc.setFontSize(9.5);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(203, 213, 225);
        let currentY = 75;
        ingredients.forEach(ing => {
            if (currentY > 280) return;
            doc.setFillColor(...primary);
            doc.circle(18, currentY - 1, 0.8, 'F');
            const splitIng = doc.splitTextToSize(ing, 50);
            doc.text(splitIng, 22, currentY);
            currentY += (splitIng.length * 5) + 3;
        });

        // --- 2. Main Body Content ---
        doc.setTextColor(...dark);

        // Header Title
        doc.setFontSize(32);
        doc.setFont(undefined, 'bold');
        const splitTitle = doc.splitTextToSize(title.toUpperCase(), 115);
        doc.text(splitTitle, 85, 30);

        let mainY = 30 + (splitTitle.length * 12) + 5;

        // Metadata Chip
        doc.setFillColor(light[0], light[1], light[2]);
        doc.roundedRect(85, mainY, 110, 10, 1, 1, 'F');
        doc.setFontSize(8);
        doc.setTextColor(...primary);
        doc.text("OFFICIAL RECIPE GUIDE â€¢ DIGITAL COLLECTION", 140, mainY + 6.5, { align: "center", charSpace: 0.5 });
        mainY += 20;

        // Description
        doc.setTextColor(71, 85, 105);
        doc.setFont(undefined, 'italic');
        doc.setFontSize(11);
        const splitDesc = doc.splitTextToSize(`"${description}"`, 115);
        doc.text(splitDesc, 85, mainY);
        mainY += (splitDesc.length * 6) + 15;

        // Preparation Steps Header
        doc.setTextColor(...dark);
        doc.setFontSize(18);
        doc.setFont(undefined, 'bold');
        doc.text("PREPARATION", 85, mainY);
        doc.setFillColor(...primary);
        doc.rect(85, mainY + 2, 25, 1.2, 'F');
        mainY += 15;

        doc.setFontSize(10.5);
        instructions.forEach((ins, i) => {
            const splitIns = doc.splitTextToSize(ins, 105);

            if (mainY + (splitIns.length * 6) > 280) {
                doc.addPage();
                // Redraw Sidebar on new page for consistency
                doc.setFillColor(...dark);
                doc.rect(0, 0, 75, 297, 'F');
                mainY = 25;
            }

            // Step Indicator
            doc.setFillColor(light[0], light[1], light[2]);
            doc.circle(90, mainY - 1, 4, 'F');
            doc.setTextColor(...primary);
            doc.setFont(undefined, 'bold');
            doc.text(`${i + 1}`, 90, mainY, { align: "center" });

            // Step Content
            doc.setTextColor(...dark);
            doc.setFont(undefined, 'normal');
            doc.text(splitIns, 98, mainY);
            mainY += (splitIns.length * 6) + 8;
        });

        // Pagination
        const total = doc.internal.getNumberOfPages();
        for (let i = 1; i <= total; i++) {
            doc.setPage(i);
            doc.setFontSize(8);
            doc.setTextColor(156, 163, 175);
            doc.text(`Cookbook Edition | Page ${i} of ${total}`, 142.5, 292, { align: "center" });
            doc.text("RECIPEHUB NETWORK", 37.5, 292, { align: "center" });
        }

        doc.save(`${title.replace(/\s+/g, '_')}_Chef_Edition.pdf`);
    }
</script>
{% endblock %}